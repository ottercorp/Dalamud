name: Sync Goatcorp

permissions:
  contents: read
  pull-requests: write

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  create-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create PR from Upstream
        env:
          GITHUB_TOKEN: ${{ secrets.SYNC_TOKEN }}
          UPSTREAM_OWNER: goatcorp
          UPSTREAM_BRANCH: master
          MY_BRANCH: master
        run: |
          HEAD_REF="$UPSTREAM_OWNER:$UPSTREAM_BRANCH"
          
          echo "æ£€æŸ¥æ˜¯å¦å­˜åœ¨ä» $HEAD_REF åˆ° $MY_BRANCH çš„ PR..."

          EXISTING_PR=$(gh pr list --state open \
                                   --base $MY_BRANCH \
                                   --head $HEAD_REF \
                                   --json url \
                                   --jq '.[0].url')

          if [ -n "$EXISTING_PR" ]; then
            echo "PR å·²å­˜åœ¨ï¼ŒPRé“¾æ¥: $EXISTING_PR"
            exit 0
          fi
          
          gh pr create \
            --repo ${{ github.repository }} \
            --base $MY_BRANCH \
            --head $HEAD_REF \
            --title "ğŸ”„ åŒæ­¥ä¸Šæ¸¸æ›´æ–°" \
            --body "@ottercorp/dalamud-maintainer ä¸Šæ¸¸ä»“åº“ ($HEAD_REF) æœ‰æ–°æäº¤ã€‚è¿™æ˜¯è‡ªåŠ¨ç”Ÿæˆçš„åŒæ­¥è¯·æ±‚ã€‚" \
            || echo "æ²¡æœ‰å‘ç°æ–°æäº¤ï¼Œæˆ–è€…åˆ›å»º PR å¤±è´¥ã€‚"